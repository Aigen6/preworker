# 策略实现说明

## 概述

系统实现了4个防匹配策略，确保生成的操作计划不会被系统匹配算法识别。策略在**计划生成时应用**，并在**生成后验证**。

## 策略实现架构

### 1. 策略配置层 (`StrategyConfig`)

```typescript
interface StrategyConfig {
  enableAmountMismatch: boolean      // 策略1开关
  minAmountDifference: number        // 最小金额差异（默认 > 0.001）
  enableTimeExtension: boolean       // 策略2开关
  minTimeInterval: number            // 最小时间间隔（默认 > 24小时）
  enableNormalTransactionMix: boolean // 策略3开关
  normalTransactionRatio: number      // 正常交易占比（默认 > 80%）
  enableRiskControl: boolean         // 策略4开关
  maxHighRiskRatio: number           // 最大高风险占比（默认 < 20%）
}
```

### 2. 策略应用层（计划生成时）

在 `handleGeneratePlan()` 函数中，按以下顺序应用策略：

#### 步骤1：生成存入交易（高风险）

```typescript
// 为每个需求地址生成存入交易
for (每个需求) {
  const depositTime = baseTime + Math.random() * 86400 // 第1天内随机
  // 创建存入交易，标记为高风险
}
```

#### 步骤2：应用策略1和策略2生成提取交易

```typescript
if (strategyConfig.enableAmountMismatch) {
  // 策略1：金额不匹配
  const withdrawAmount = generateMismatchedAmount(
    depositAmount,                    // 存入金额
    strategyConfig.minAmountDifference // 最小差异（> 0.001）
  )
  
  // 策略2：时间延长
  const withdrawTime = generateWithdrawTime(
    depositTime,                      // 存入时间
    strategyConfig.minTimeInterval    // 最小间隔（> 24小时）
  )
  
  // 创建提取交易，记录金额差异和时间间隔
  withdrawTx.amountDifference = Math.abs(withdrawAmount - depositAmount)
  withdrawTx.timeInterval = withdrawTime - depositTime
}
```

**关键函数：**

1. **`generateMismatchedAmount()`** - 生成不匹配的金额
   ```typescript
   // 随机选择增加或减少
   const shouldIncrease = Math.random() > 0.5
   const difference = minDifference + Math.random() * depositAmount * 0.5
   // 确保差异 > 0.001 ETH/BSC
   ```

2. **`generateWithdrawTime()`** - 生成延后的时间
   ```typescript
   // 随机间隔在 minInterval 到 minInterval * 3 之间
   const interval = minInterval + Math.random() * minInterval * 2
   return depositTime + interval // 确保 > 24小时
   ```

#### 步骤3：应用策略3生成正常交易

```typescript
if (strategyConfig.enableNormalTransactionMix) {
  // 计算需要的正常交易数量
  const highRiskCount = depositTransactions.length + withdrawTransactions.length
  const requiredNormalCount = Math.ceil(
    (highRiskCount * normalTransactionRatio) / (1 - normalTransactionRatio)
  )
  // 例如：高风险20笔，正常占比80%，需要生成 20 * 0.8 / 0.2 = 80 笔正常交易
  
  // 生成正常交易，随机分布在3天内
  for (let i = 0; i < requiredNormalCount; i++) {
    const normalTime = baseTime + Math.random() * 86400 * 3
    // 创建正常交易，isHighRisk = false
  }
}
```

#### 步骤4：应用策略4 - 时间交叉

```typescript
// 合并所有交易并按时间排序
const allTransactions = [
  ...depositTransactions,   // 高风险存入
  ...withdrawTransactions, // 高风险提取
  ...normalTransactions,   // 正常交易
].sort((a, b) => {
  const timeA = a.depositTime || a.withdrawTime || 0
  const timeB = b.depositTime || b.withdrawTime || 0
  return timeA - timeB  // 按时间排序，实现交叉
})
```

**时间交叉效果：**
```
第1天 10:00 - 高风险存入 A
第1天 11:00 - 正常存入 C1
第1天 14:00 - 正常提取 C2
第2天 09:00 - 正常存入 C3
第3天 14:00 - 高风险提取 B（与A金额不一致，时间间隔 > 48小时）
第3天 15:00 - 正常提取 C4
```

### 3. 策略验证层（生成后验证）

在计划生成后，执行所有策略验证：

```typescript
const strategyValidation = validateAllStrategies(
  allTransactions,
  strategyConfig
)
```

#### 验证函数实现

**策略1验证：金额不匹配**

```typescript
function validateAmountMismatch(transactions, config) {
  for (const tx of transactions) {
    if (tx.relatedDepositId && tx.amountDifference !== undefined) {
      const difference = Math.abs(tx.amountDifference)
      
      if (difference <= config.minAmountDifference) {
        // ❌ 失败：金额差异太小，可能被匹配
        failedCount++
      }
    }
  }
  return { passed: failedCount === 0, failedCount, details }
}
```

**策略2验证：时间延长**

```typescript
function validateTimeExtension(transactions, config) {
  for (const tx of transactions) {
    if (tx.depositTime && tx.withdrawTime && tx.timeInterval !== undefined) {
      const interval = tx.timeInterval
      
      if (interval <= config.minTimeInterval) {
        // ❌ 失败：时间间隔太短，可能被匹配
        failedCount++
      }
    }
  }
  return { passed: failedCount === 0, failedCount, details }
}
```

**策略3验证：正常交易交叉**

```typescript
function validateNormalTransactionMix(transactions, config) {
  const highRiskCount = transactions.filter(tx => tx.isHighRisk).length
  const normalCount = transactions.filter(tx => !tx.isHighRisk).length
  const totalCount = transactions.length
  
  const highRiskRatio = highRiskCount / totalCount
  const normalRatio = normalCount / totalCount
  
  const passed = normalRatio >= config.normalTransactionRatio
  
  return {
    passed,
    highRiskRatio,
    normalRatio,
    reason: passed 
      ? `正常交易占比 ${normalRatio * 100}% >= ${config.normalTransactionRatio * 100}%`
      : `正常交易占比 ${normalRatio * 100}% < ${config.normalTransactionRatio * 100}%`
  }
}
```

**策略4验证：风险控制**

```typescript
function validateRiskControl(transactions, config) {
  const highRiskCount = transactions.filter(tx => tx.isHighRisk).length
  const totalCount = transactions.length
  const highRiskRatio = highRiskCount / totalCount
  
  const passed = highRiskRatio <= config.maxHighRiskRatio
  
  return {
    passed,
    highRiskCount,
    totalCount,
    highRiskRatio,
    reason: passed
      ? `高风险交易占比 ${highRiskRatio * 100}% <= ${config.maxHighRiskRatio * 100}%`
      : `高风险交易占比 ${highRiskRatio * 100}% > ${config.maxHighRiskRatio * 100}%`
  }
}
```

## 策略应用流程图

```
用户输入参数
    ↓
生成存入交易（高风险）
    ↓
应用策略1：生成金额不匹配的提取交易
    ├─ generateMismatchedAmount() → 确保差异 > 0.001
    └─ 记录 amountDifference
    ↓
应用策略2：生成时间延后的提取交易
    ├─ generateWithdrawTime() → 确保间隔 > 24小时
    └─ 记录 timeInterval
    ↓
应用策略3：生成正常交易
    ├─ 计算需要的正常交易数量（确保占比 > 80%）
    └─ 随机分布在3天内
    ↓
应用策略4：时间交叉
    └─ 按时间排序所有交易
    ↓
执行策略验证
    ├─ validateAmountMismatch()
    ├─ validateTimeExtension()
    ├─ validateNormalTransactionMix()
    └─ validateRiskControl()
    ↓
生成最终计划 + 任务列表
```

## 关键设计点

### 1. 策略应用时机
- **生成时应用**：在创建交易时就应用策略，确保生成的交易符合要求
- **生成后验证**：再次验证确保所有策略都满足

### 2. 随机性
- 金额差异：随机选择增加或减少，差异在 `minDifference` 到 `50%` 之间
- 时间间隔：随机间隔在 `minInterval` 到 `minInterval * 3` 之间
- 正常交易时间：随机分布在3天内

### 3. 数据关联
- 提取交易通过 `relatedDepositId` 关联存入交易
- 记录 `amountDifference` 和 `timeInterval` 用于验证

### 4. 可配置性
- 每个策略都可以独立开启/关闭
- 所有参数都可以调整（金额差异、时间间隔、占比等）

## 匹配算法对比

系统匹配算法的条件：
- 金额差异 <= 0.001 ETH/BSC → 匹配
- 时间差异 <= 24小时 → 匹配

我们的策略：
- 金额差异 > 0.001 ETH/BSC → ✅ 不匹配
- 时间间隔 > 24小时 → ✅ 不匹配
- 正常交易交叉 → ✅ 混在正常交易中
- 风险控制 → ✅ 保持低风险占比

## 示例

假设用户输入：
- 总量 A = 10000 USDT
- 地址数 M = 5
- 每地址需求：1000 USDT × 10笔

生成过程：

1. **存入交易**：5个地址 × 10笔 = 50笔存入（高风险）
2. **提取交易**：50笔提取
   - 金额：每笔与存入金额差异 > 0.001（例如：存入1000，提取1500或500）
   - 时间：每笔与存入时间间隔 > 48小时
3. **正常交易**：计算需要 50 × 0.8 / 0.2 = 200笔正常交易
4. **时间排序**：所有250笔交易按时间排序，实现交叉
5. **验证**：检查所有策略是否满足

最终结果：
- ✅ 金额不匹配：所有提取金额与存入金额差异 > 0.001
- ✅ 时间延长：所有时间间隔 > 48小时
- ✅ 正常交易交叉：正常交易占比 80%，高风险占比 20%
- ✅ 风险控制：高风险交易占比 < 20%
