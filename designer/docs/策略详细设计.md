# 白U操作计划策略详细设计文档

## 概述

本文档详细说明白U操作计划的4个防匹配策略的设计思路、实现逻辑和具体要求，以及合约需要支持的功能。

## 匹配算法回顾

系统匹配算法的条件：
- **金额容差 (AMOUNT_TOLERANCE)**: 0.001 ETH/BSC
- **时间容差 (TIME_TOLERANCE)**: 24小时（86400秒）

匹配条件：
- 金额差异 <= 0.001 ETH/BSC → **会被匹配**
- 时间差异 <= 24小时 → **会被匹配**
- 如果地址相同，增加置信度

## 策略1：金额不匹配策略

### 设计目标

确保提取金额与存入金额的差异 > 0.001 ETH/BSC，避免被匹配算法识别。

### 实现方式

#### 方式1：拆分提取（一次存入，多次提取）

**逻辑：**
- 一次存入可以分成 **2-3次** 分开提取
- 每次提取的金额与存入金额不一致
- 确保所有提取金额的总和与存入金额的差异 > 0.001

**示例：**
```
存入：1000 USDT（地址A）
提取1：400 USDT（地址B1）
提取2：350 USDT（地址B2）
提取3：250 USDT（地址B3）
总计：400 + 350 + 250 = 1000 USDT ✅（必须等于存入金额）

金额差异检查（每个提取 vs 存入）：
- 提取1 vs 存入：|400 - 1000| = 600 > 0.001 ✅
- 提取2 vs 存入：|350 - 1000| = 650 > 0.001 ✅
- 提取3 vs 存入：|250 - 1000| = 750 > 0.001 ✅

关键点：
- 每个提取金额 ≠ 存入金额（差异 > 0.001）✅
- 所有提取总和 = 存入金额 ✅
```

#### 方式2：分散提取（同一存入地址，多个提取地址）

**逻辑：**
- 同一地址存入，可以从 **多个不同地址** 提取
- 每个提取地址的金额与存入金额不一致
- 增加地址多样性，降低关联性

**示例：**
```
存入：1000 USDT（地址A）
提取1：600 USDT（地址B1）
提取2：500 USDT（地址B2）
提取3：400 USDT（地址B3）

每个提取地址都不同，且金额与存入不一致 ✅
```

#### 方式3：配合白U存入和提取

**逻辑：**
- 白U地址存入 → 预处理 → Enclave隐私化 → 提取到目标地址
- 在提取阶段，可以：
  - 从多个白U地址提取
  - 提取到多个目标地址
  - 每次提取金额与原始存入不一致

**完整流程示例：**
```
步骤1：白U地址A存入 1000 USDT → 预处理池
步骤2：Enclave隐私化处理
步骤3：提取阶段
  - 提取1：400 USDT → 目标地址B1
  - 提取2：350 USDT → 目标地址B2
  - 提取3：250 USDT → 目标地址B3
  - 总计：400 + 350 + 250 = 1000 USDT ✅（等于存入金额）

每个提取的金额都与原始存入 1000 USDT 不一致 ✅
所有提取的总和等于存入金额 ✅（资金平衡）
```

### 策略1的具体要求

1. **拆分次数**：每次存入可以分成 2-3 次提取
2. **提取地址**：每次提取使用不同的目标地址
3. **金额差异**：每个提取金额与存入金额的差异必须 > 0.001 ETH/BSC
4. **总量一致**：**所有提取金额的总和必须等于存入金额**（资金平衡）
5. **系统自动计算**：系统自动计算每个提取的金额，确保：
   - 每个提取金额 ≠ 存入金额（差异 > 0.001）
   - 所有提取总和 = 存入金额

### 策略1的生成规则

系统在生成计划时，必须按照以下规则：

1. **拆分提取**：每次存入自动分成 2-3 次提取
2. **金额不匹配**：每个提取金额自动计算，确保与存入金额差异 > 0.001
3. **总量一致**：系统自动计算，确保所有提取金额总和 = 存入金额
4. **分散地址**：每次提取自动分配到不同的目标地址
5. **自动计算算法**：
   ```
   存入金额 = 1000 USDT
   提取次数 = 2-3次（随机）
   
   算法：
   - 随机生成2-3个提取金额，每个金额 ≠ 存入金额（差异 > 0.001）
   - 调整最后一个提取金额，确保总和 = 存入金额
   - 验证每个提取金额与存入金额的差异 > 0.001
   ```

---

## 策略2：时间控制策略

### 设计目标

通过控制高风险和低风险交易的提取时间，实现时间交叉，避免被匹配算法识别。

### 实现方式

**逻辑：**
- **低风险U的提取时间**：存入后 5-120 分钟
- **高风险U的提取时间**：存入后 10-40 分钟
- **时间交叉**：高风险和低风险的提取时间需要交叉分布

**示例：**
```
时间线（从存入时间开始）：

第1天 10:00 - 低风险存入：2000 USDT
第1天 10:15 - 高风险存入：1000 USDT（存入后15分钟）
第1天 10:20 - 高风险提取：400 USDT（高风险存入后20分钟，在10-40分钟范围内）✅
第1天 10:30 - 低风险提取：1500 USDT（低风险存入后30分钟，在5-120分钟范围内）✅
第1天 10:45 - 高风险提取：350 USDT（高风险存入后30分钟，在10-40分钟范围内）✅
第1天 11:00 - 低风险提取：500 USDT（低风险存入后60分钟，在5-120分钟范围内）✅
第1天 11:15 - 高风险提取：250 USDT（高风险存入后60分钟，超出10-40分钟范围）❌
```

### 策略2的具体要求

1. **低风险提取时间**：存入后 5-120 分钟（300秒 - 7200秒）
2. **高风险提取时间**：存入后 10-40 分钟（600秒 - 2400秒）
3. **时间交叉**：高风险和低风险的提取时间需要交叉分布，不能完全分离
4. **多次提取**：如果是一次存入多次提取，每次提取的时间都要满足对应的时间范围

### 策略2的生成规则

系统在生成计划时，必须按照以下规则：

1. **低风险提取时间**：自动计算在存入后 5-120 分钟范围内（随机）
2. **高风险提取时间**：自动计算在存入后 10-40 分钟范围内（随机）
3. **时间交叉**：系统自动安排高风险和低风险提取时间交叉分布
4. **自动分配**：系统自动分配每个提取的时间，确保满足时间范围和交叉要求

### 时间交叉的判定标准

**交叉判定：**
- 高风险提取时间范围：[存入时间 + 10分钟, 存入时间 + 40分钟]
- 低风险提取时间范围：[存入时间 + 5分钟, 存入时间 + 120分钟]
- 交叉区域：[存入时间 + 10分钟, 存入时间 + 40分钟]

**要求：**
- 至少有一些低风险提取在交叉区域内（10-40分钟）
- 或者高风险和低风险提取在时间上交替出现
- 不能所有高风险提取都在前面，所有低风险提取都在后面

---

## 策略3：正常交易交叉策略

### 设计目标

将高风险交易混在正常交易中，看起来像正常用户的交易，降低被识别的风险。

### 实现方式

**逻辑：**
- 生成足够多的正常交易（正常用户C的交易）
- 正常交易占比 > 80%
- 高风险交易占比 < 20%
- 所有交易按时间排序，实现时间交叉

**时间线示例：**
```
第1天 10:00 - A存入：1000 USDT（高风险地址）
第1天 11:00 - C1存入：2000 USDT（正常用户）
第1天 14:00 - C2提取：1500 USDT（正常用户）
第2天 09:00 - C3存入：3000 USDT（正常用户）
第2天 15:00 - C4提取：1000 USDT（正常用户）
第3天 14:00 - B提取：400 USDT（高风险提取，与A金额不一致，时间间隔 > 48小时）
第3天 15:00 - C5提取：2000 USDT（正常用户）
第4天 09:00 - B提取：350 USDT（高风险提取，与A金额不一致）
第4天 14:00 - C6存入：1500 USDT（正常用户）
第5天 15:00 - B提取：250 USDT（高风险提取，与A金额不一致）
```

### 策略3的具体要求

1. **正常交易占比**：> 80%
2. **高风险交易占比**：< 20%
3. **时间交叉**：高风险交易与正常交易在时间上交叉分布
4. **交易多样性**：正常交易要有存入和提取，金额和时间要随机

### 策略3的生成规则

系统在生成计划时，必须按照以下规则：

1. **自动计算正常交易数量**：根据高风险交易数量，自动计算需要的正常交易数量
   - 公式：正常交易数 = 高风险数 × 正常占比 / (1 - 正常占比)
   - 例如：高风险20笔，正常占比80%，需要生成 20 × 0.8 / 0.2 = 80笔正常交易
2. **自动生成正常交易**：系统自动生成足够数量的正常交易
3. **自动时间排序**：系统自动按时间排序所有交易，实现交叉
4. **自动分配**：系统自动分配正常交易的时间、金额和地址

---

## 策略4：风险控制策略

### 设计目标

控制高风险交易的整体占比（笔数和总量），确保合约的风险评分保持低风险。

### 实现方式

**逻辑：**
- **交易笔数占比**：高风险交易占比 < 20%，正常交易占比 > 80%
- **交易总量占比**：低风险U的总量需要是高风险U的 **5-10倍**
- 在3天/10天内，确保合约的风险评分保持低风险

**计算方式：**

1. **交易笔数占比：**
```
高风险交易占比 = (高风险交易数量 / 总交易数量) × 100%
正常交易占比 = (正常交易数量 / 总交易数量) × 100%
```

2. **交易总量占比：**
```
高风险U总量 = 所有高风险交易的金额总和
低风险U总量 = 所有低风险交易的金额总和
总量比例 = 低风险U总量 / 高风险U总量

要求：总量比例 >= 5 且 <= 10
```

**示例：**

**交易笔数：**
```
总交易数：100笔
高风险交易：15笔（15% < 20%）✅
正常交易：85笔（85% > 80%）✅
```

**交易总量：**
```
高风险U总量：10000 USDT
低风险U总量：60000 USDT
总量比例：60000 / 10000 = 6倍（在5-10倍范围内）✅

或者：
高风险U总量：10000 USDT
低风险U总量：50000 USDT
总量比例：50000 / 10000 = 5倍（在5-10倍范围内）✅

或者：
高风险U总量：10000 USDT
低风险U总量：100000 USDT
总量比例：100000 / 10000 = 10倍（在5-10倍范围内）✅
```

### 策略4的具体要求

1. **交易笔数占比**：
   - 高风险交易占比 < 20%
   - 正常交易占比 > 80%

2. **交易总量占比**：
   - 低风险U总量 / 高风险U总量 >= 5倍
   - 低风险U总量 / 高风险U总量 <= 10倍
   - 即：低风险U总量 = 高风险U总量 × (5-10倍)

3. **时间窗口**：在3天/10天内保持低风险

4. **动态调整**：
   - 如果高风险笔数占比过高，自动增加正常交易笔数
   - 如果高风险总量占比过高，自动增加正常交易总量

### 策略4的生成规则

系统在生成计划时，必须按照以下规则：

1. **自动控制高风险笔数占比**：系统自动控制高风险交易笔数占比 < 20%
2. **自动控制高风险总量占比**：系统自动控制低风险U总量 = 高风险U总量 × (5-10倍)
3. **自动增加正常交易**：
   - 如果高风险笔数占比过高，自动增加正常交易笔数
   - 如果高风险总量占比过高，自动增加正常交易总量
4. **自动平衡**：系统自动平衡高风险和正常交易的笔数和总量比例
5. **自动调整**：系统自动调整交易数量和金额，确保满足占比要求

**计算示例：**
```
假设高风险U总量 = 10000 USDT

需要低风险U总量 = 10000 × (5-10倍) = 50000-100000 USDT

系统自动生成：
- 正常交易笔数：确保占比 > 80%
- 正常交易总量：50000-100000 USDT（随机在范围内）
- 确保总量比例在5-10倍之间
```

---

## 策略应用说明

### 重要说明

**策略是生成规则，不是验证规则！**

- ✅ 系统在生成计划时，**自动应用**这些策略
- ✅ 系统**自动计算**金额、时间、地址等，确保满足策略要求
- ✅ 人工按照生成的计划**执行操作**，不需要验证
- ❌ 不是生成后再验证是否满足策略
- ❌ 不是人工判断策略是否满足

### 工作流程

```
用户输入参数
    ↓
系统自动应用策略1：生成金额不匹配的提取（自动拆分、自动计算金额）
    ↓
系统自动应用策略2：分配提取时间（高风险10-40分钟，低风险5-120分钟，自动交叉）
    ↓
系统自动应用策略3：生成正常交易（自动计算数量，自动分配时间）
    ↓
系统自动应用策略4：控制风险占比（自动平衡高风险和正常交易）
    ↓
生成完整的操作计划
    ↓
生成任务列表（每个任务包含具体的时间、金额、地址）
    ↓
人工按照任务列表执行操作
```

## 输入参数设计

### 输入方式

用户直接输入高风险地址列表，每个地址对应一个数量：

```
高风险地址列表：
- 地址1：1000 USDT
- 地址2：2000 USDT
- 地址3：1500 USDT
- 地址4：3000 USDT
- 地址5：2500 USDT
...
地址x：数量x USDT
```

**系统自动计算：**
- 高风险U总量 = 所有地址数量之和
- 高风险地址数 = 输入的地址数量
- 需要低风险U总量 = 高风险U总量 × (5-10倍)
- 每个地址的存入和提取计划由系统根据策略自动生成

## 策略组合应用

### 完整示例

**输入参数：**
```
高风险地址列表：
- 地址1：1000 USDT
- 地址2：2000 USDT
- 地址3：1500 USDT
- 地址4：3000 USDT
- 地址5：2500 USDT

系统自动计算：
- 高风险U总量 = 1000 + 2000 + 1500 + 3000 + 2500 = 10000 USDT
- 高风险地址数 = 5
- 需要低风险U总量 = 10000 × (5-10倍) = 50000-100000 USDT
```

**生成过程：**

1. **存入阶段**
   - **高风险存入**：
     - 地址1：1000 USDT（系统自动决定分成几笔存入）
     - 地址2：2000 USDT
     - 地址3：1500 USDT
     - 地址4：3000 USDT
     - 地址5：2500 USDT
     - 总计：10000 USDT
   
   - **低风险存入**：系统自动生成足够的低风险存入（总量50000-100000 USDT）
   - 存入时间：第1天内随机分布

2. **提取阶段**（应用策略1和策略2）
   - **高风险提取**：
     - 每个高风险地址的存入分成 2-3 次提取
     - 例如：地址1存入1000 USDT → 提取1: 400 USDT, 提取2: 350 USDT, 提取3: 250 USDT
     - 每次提取金额：与存入金额不一致（差异 > 0.001）
     - **所有提取总和 = 存入金额**（资金平衡）
     - 每次提取时间：存入后 10-40 分钟
     - 每次提取地址：不同的目标地址
   
   - **低风险提取**：
     - 每笔低风险存入分成 2-3 次提取
     - 每次提取金额：与存入金额不一致（差异 > 0.001）
     - **所有提取总和 = 存入金额**（资金平衡）
     - 每次提取时间：存入后 5-120 分钟
     - 每次提取地址：不同的目标地址

3. **时间交叉**（应用策略2）
   - 高风险和低风险提取时间交叉分布
   - 确保在交叉区域（10-40分钟）内有低风险提取
   - 高风险和低风险提取在时间上交替出现

4. **正常交易生成**（应用策略3和策略4）
   - **交易笔数**：
     - 高风险交易总数：存入笔数 + 提取笔数
     - 需要正常交易笔数：高风险笔数 × 0.8 / 0.2
   
   - **交易总量**：
     - 高风险U总量：10000 USDT（从输入参数计算）
     - 需要低风险U总量：10000 × (5-10倍) = 50000-100000 USDT
     - 系统自动生成正常交易，确保总量在范围内
   
   - **时间交叉**：正常交易时间与高风险和低风险提取时间交叉

5. **时间排序**（应用策略4）
   - 所有交易按时间排序：175笔高风险 + 700笔正常 = 875笔
   - 实现时间交叉

6. **自动应用策略**
   - 策略1：系统自动将每笔存入分成2-3次提取，每个提取金额≠存入金额（差异>0.001），但所有提取总和=存入金额 ✅
   - 策略2：系统自动分配提取时间（高风险10-40分钟，低风险5-120分钟），自动交叉 ✅
   - 策略3：系统自动生成700笔正常交易，笔数占比80% ✅
   - 策略4：系统自动控制高风险笔数占比20%，总量占比（低风险/高风险）在5-10倍 ✅

7. **生成任务列表**
   - 系统自动从计划生成任务列表
   - 每个任务包含：时间、金额、地址、操作步骤
   - 人工按照任务列表执行操作

### 策略优先级

1. **策略1和策略2**：必须满足（否则会被匹配）
2. **策略3和策略4**：建议满足（降低风险）

---

## 必须避免的错误做法

## 系统生成要求

系统在生成计划时，必须确保：

| 要求 | 说明 | 系统行为 |
|------|------|---------|
| 金额不匹配 | 每个提取金额与存入金额差异 > 0.001 | 系统自动计算每个提取金额 |
| 总量一致 | 所有提取总和 = 存入金额（资金平衡） | 系统自动计算，确保总和一致 |
| 拆分提取 | 每次存入分成2-3次提取 | 系统自动拆分 |
| 分散地址 | 每次提取使用不同地址 | 系统自动分配不同地址 |
| 高风险时间 | 高风险提取在存入后10-40分钟 | 系统自动分配时间 |
| 低风险时间 | 低风险提取在存入后5-120分钟 | 系统自动分配时间 |
| 时间交叉 | 高风险和低风险提取时间交叉 | 系统自动安排交叉 |
| 正常交易笔数占比 | 正常交易笔数占比 > 80% | 系统自动生成足够正常交易笔数 |
| 正常交易总量占比 | 低风险U总量 = 高风险U总量 × (5-10倍) | 系统自动生成足够正常交易总量 |
| 高风险笔数占比 | 高风险笔数占比 < 20% | 系统自动控制笔数占比 |
| 高风险总量占比 | 低风险/高风险总量比例在5-10倍 | 系统自动控制总量占比 |

---

## 策略配置参数

### 策略1配置
- `enableAmountMismatch`: 是否启用金额不匹配策略
- `minAmountDifference`: 最小金额差异（默认 > 0.001）
- `splitCount`: 每次存入的提取次数（2-3次）
- `useMultipleAddresses`: 是否使用多个提取地址

### 策略2配置
- `enableTimeControl`: 是否启用时间控制策略
- `lowRiskTimeRange`: 低风险提取时间范围（默认 5-120 分钟）
  - `min`: 5分钟（300秒）
  - `max`: 120分钟（7200秒）
- `highRiskTimeRange`: 高风险提取时间范围（默认 10-40 分钟）
  - `min`: 10分钟（600秒）
  - `max`: 40分钟（2400秒）
- `requireTimeCross`: 是否要求时间交叉（默认 true）

### 策略3配置
- `enableNormalTransactionMix`: 是否启用正常交易交叉策略
- `normalTransactionRatio`: 正常交易占比（默认 > 80%）
- `transactionDistribution`: 交易时间分布（3天内随机）

### 策略4配置
- `enableRiskControl`: 是否启用风险控制策略
- `maxHighRiskRatio`: 最大高风险笔数占比（默认 < 20%）
- `minLowRiskAmountRatio`: 最小低风险总量比例（默认 5倍）
- `maxLowRiskAmountRatio`: 最大低风险总量比例（默认 10倍）
- `timeWindow`: 时间窗口（3天/10天）

---

## 合约功能要求

### DepositVault 合约需要支持的功能

#### 存入功能

1. **存入USDT（自动换成jUSDT）**
   - 用户存入USDT
   - 合约自动调用借贷协议，将USDT换成jUSDT
   - jUSDT托管在合约中

2. **直接存入jUSDT**
   - 用户直接存入jUSDT
   - jUSDT直接托管在合约中
   - 不需要经过借贷协议转换

#### 取出功能

1. **直接取出USDT**
   - 合约自动从借贷协议赎回jUSDT，换成USDT
   - 将USDT转给用户

2. **取出jUSDT（用户自己转换成USDT）**
   - 合约直接将jUSDT转给用户
   - 用户自己调用借贷协议将jUSDT换成USDT

### 实现方式

**新增函数：**

1. `depositWithYieldToken()` - 直接存入yield token（jUSDT/aUSDT等）
   ```solidity
   function depositWithYieldToken(
       address yieldToken,        // yield token地址（jUSDT、aEthUSDT、aBnbUSDT等）
       uint256 yieldAmount,       // yield token数量
       address intendedRecipient   // 预期接收地址
   ) external returns (uint256 depositId)
   ```
   - 自动从yieldToken获取底层代币地址（支持JustLend和AAVE）
   - 无需手动提供underlyingToken

2. `claimAsUnderlying()` - 取出USDT（自动赎回）
   ```solidity
   function claimAsUnderlying(uint256 depositId) external
   ```
   - 合约自动从借贷协议赎回jUSDT，换成USDT
   - 将USDT转给用户

3. `recoverAsUnderlying()` - 取回USDT（自动赎回）
   ```solidity
   function recoverAsUnderlying(uint256 depositId) external
   ```
   - 合约自动从借贷协议赎回jUSDT，换成USDT
   - 将USDT转给存款人

**现有函数保持不变：**
- `deposit(token, amount, intendedRecipient)` - 存入USDT，自动换成jUSDT
- `claim(depositId)` - 取出jUSDT（用户自己转换成USDT）
- `recover(depositId)` - 取回jUSDT（用户自己转换成USDT）

### 使用场景

**场景1：存入USDT，取出USDT**
```
存入：deposit(USDT, 1000) → 自动换成jUSDT
取出：claimAsUnderlying(depositId) → 自动赎回USDT
```

**场景2：存入USDT，取出jUSDT**
```
存入：deposit(USDT, 1000) → 自动换成jUSDT
取出：claim(depositId) → 直接取出jUSDT
```

**场景3：存入jUSDT，取出USDT**
```
存入：depositWithYieldToken(jUSDT, 1000) → 直接存入jUSDT
取出：claimAsUnderlying(depositId) → 自动赎回USDT
```

**场景4：存入jUSDT，取出jUSDT**
```
存入：depositWithYieldToken(jUSDT, 1000, recipient) → 直接存入jUSDT（自动识别USDT）
取出：claim(depositId) → 直接取出jUSDT（用户自己转换成USDT）
```

### 注意事项

1. **depositWithYieldToken 自动识别底层代币**：
   - 自动从yieldToken获取底层代币地址（支持JustLend的`underlying()`和AAVE的`UNDERLYING_ASSET_ADDRESS()`）
   - 无需手动提供underlyingToken参数
   - 后续 `claimAsUnderlying()` 或 `recoverAsUnderlying()` 会根据底层代币找到对应的适配器

2. **claimAsUnderlying 和 recoverAsUnderlying 会自动赎回**：
   - 合约自动调用借贷协议的赎回函数
   - 将jUSDT换成USDT后转给用户
   - 用户无需手动转换

3. **claim 和 recover 返回jUSDT**：
   - 用户需要自己调用借贷协议将jUSDT换成USDT
   - 适合需要更多控制的场景

## 更新日志

- 2025-01-21: 初始版本，详细设计策略1-4
- 2025-01-21: 更新策略1，明确拆分提取和分散提取的实现方式
- 2025-01-21: 更新策略2，明确高风险和低风险的提取时间要求（高风险10-40分钟，低风险5-120分钟），并添加时间交叉要求
- 2025-01-21: 重要修正 - 明确策略是**生成规则**，系统自动应用策略生成计划，人工按照计划执行，不是验证规则
- 2025-01-21: 策略1修正 - 明确所有提取总和必须等于存入金额（资金平衡），每个提取金额与存入金额不一致
- 2025-01-21: 策略4更新 - 增加交易总量占比要求，低风险U总量需要是高风险U的5-10倍
- 2025-01-21: 输入参数更新 - 改为直接输入高风险地址和数量列表，系统自动计算总量和生成策略
- 2025-01-21: 合约功能要求 - 添加支持存入USDT/jUSDT和取出USDT/jUSDT的功能要求
